{% extends "base.html" %}
{% block title %}Ortobahn - My Dashboard{% endblock %}
{% block nav_home %}/my/dashboard{% endblock %}
{% block nav_links %}
<li><a href="/my/dashboard">Dashboard</a></li>
<li><a href="/my/settings">Settings</a></li>
<li><a href="/api/auth/logout" onclick="fetch('/api/auth/logout',{method:'POST'}).then(()=>location.href='/api/auth/login');return false;">Log Out</a></li>
{% endblock %}
{% block content %}
<h1>{{ client.name }}</h1>

{% if not client.internal %}
{% if subscription_status == 'trialing' and trial_days_remaining is not none %}
<article style="background: {% if trial_days_remaining <= 3 %}#fecaca{% else %}#fef3c7{% endif %}; border-left: 4px solid {% if trial_days_remaining <= 3 %}#dc2626{% else %}#f59e0b{% endif %}; color: #1a1a1a; padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <strong>Free trial:</strong> {{ trial_days_remaining }} day{{ 's' if trial_days_remaining != 1 else '' }} remaining.
    <a href="/my/subscribe" style="margin-left: 0.5rem; font-weight: 600;">Subscribe now &rarr;</a>
</article>
{% elif subscription_status in ('expired', 'none', 'cancelled') %}
<article style="background: #fecaca; border-left: 4px solid #dc2626; color: #1a1a1a; padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <strong>{% if subscription_status == 'expired' %}Your free trial has ended.{% elif subscription_status == 'cancelled' %}Your subscription has been cancelled.{% else %}No active subscription.{% endif %}</strong>
    Subscribe to continue generating content.
    <a href="/my/subscribe" style="margin-left: 0.5rem; font-weight: 600;">Subscribe now &rarr;</a>
</article>
{% elif subscription_status == 'past_due' %}
<article style="background: #fecaca; border-left: 4px solid #dc2626; color: #1a1a1a; padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <strong>Payment failed.</strong> Please update your payment method to continue.
    <form method="post" action="/my/billing" style="display: inline;">
        <button type="submit" class="outline" style="padding: 0.25rem 0.75rem; margin-left: 0.5rem;">Manage billing &rarr;</button>
    </form>
</article>
{% endif %}
{% endif %}

<div class="grid">
    <article>
        <header>Published Posts</header>
        <p><strong>{{ total_published }}</strong></p>
    </article>
    <article>
        <header>Drafts Pending</header>
        <p><strong>{{ total_drafts }}</strong></p>
    </article>
    <article>
        <header>Status</header>
        <p><strong>{{ client.status or "active" }}</strong></p>
        {% if auto_publish %}
        <small>Auto-publish: enabled</small>
        {% else %}
        <small>Auto-publish: off (drafts only)</small>
        {% endif %}
    </article>
</div>

<h2>Content Output</h2>
<article hx-get="/my/api/health" hx-trigger="load, every 30s" hx-swap="innerHTML">
    <p style="opacity:0.6">Loading...</p>
</article>

<h2>Self-Monitoring</h2>
<article hx-get="/my/api/watchdog" hx-trigger="load, every 30s" hx-swap="innerHTML">
    <p style="opacity:0.6">Loading...</p>
</article>

<h2>Generate Content</h2>
<article>
    <form method="post" action="/my/generate">
        <div class="grid">
            <div>
                <label for="platforms">Platforms</label>
                <select id="platforms" name="platforms">
                    <option value="bluesky" selected>Bluesky</option>
                    <option value="bluesky,twitter">Bluesky + Twitter</option>
                    <option value="bluesky,twitter,linkedin">All Platforms</option>
                </select>
            </div>
            <div>
                <label>
                    <input type="checkbox" name="auto_publish" value="true" {% if auto_publish %}checked{% endif %}>
                    Auto-publish (skip draft review)
                </label>
            </div>
        </div>
        <button type="submit" {% if not client.internal and subscription_status not in ('active', 'trialing') %}disabled title="Subscribe to generate content"{% endif %}>Generate Content</button>
    </form>
</article>

<article hx-get="/my/api/pipeline-status" hx-trigger="load, every 5s" hx-swap="innerHTML">
    <div class="glass-status-card">
        <span class="glass-pulse idle"></span>
        <strong>Pipeline idle</strong> &mdash; checking status...
    </div>
</article>

{% if connected_platforms %}
<p><small>Connected platforms: {{ connected_platforms | join(', ') }}</small></p>
{% else %}
<article>
    <p>No platforms connected yet. <a href="/my/settings">Connect a platform</a> to start publishing.</p>
</article>
{% endif %}

{% if strategy %}
<h2>Active Strategy</h2>
<article>
    <p><strong>Themes:</strong> {{ strategy.themes|join(', ') }}</p>
    <p><strong>Tone:</strong> {{ strategy.tone }}</p>
    <p><strong>Posting frequency:</strong> {{ strategy.posting_frequency }}</p>
    <p><small>Valid until: {{ strategy.valid_until }}</small></p>
</article>
{% endif %}

{% if posts %}
<h2>Recent Posts</h2>
<table>
    <thead>
        <tr>
            <th>Text</th>
            <th>Status</th>
            <th>Platform</th>
            <th>Likes</th>
            <th>Reposts</th>
            <th>Published</th>
        </tr>
    </thead>
    <tbody>
        {% for p in posts %}
        <tr>
            <td>{{ p.text[:80] }}{% if p.text|length > 80 %}...{% endif %}</td>
            <td>
                {% if p.status == 'published' %}
                <span class="badge completed">published</span>
                {% elif p.status == 'draft' %}
                <span class="badge running">draft</span>
                {% elif p.status == 'failed' %}
                <span class="badge failed">failed</span>
                {% else %}
                <span class="badge">{{ p.status }}</span>
                {% endif %}
            </td>
            <td>{{ p.platform or "generic" }}</td>
            <td>{{ p.like_count or 0 }}</td>
            <td>{{ p.repost_count or 0 }}</td>
            <td>{{ p.published_at or "-" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<article>
    <p>No posts yet. Click "Generate Content" above to create your first content.</p>
</article>
{% endif %}

{% if recent_runs %}
<h2>Recent Pipeline Runs</h2>
<table>
    <thead>
        <tr>
            <th>Run ID</th>
            <th>Status</th>
            <th>Posts</th>
            <th>Started</th>
        </tr>
    </thead>
    <tbody>
        {% for run in recent_runs %}
        <tr>
            <td><code>{{ run.id[:8] }}</code></td>
            <td>
                {% if run.status == 'completed' %}
                <span class="badge completed">completed</span>
                {% elif run.status == 'failed' %}
                <span class="badge failed">failed</span>
                {% else %}
                <span class="badge running">{{ run.status }}</span>
                {% endif %}
            </td>
            <td>{{ run.posts_published }}</td>
            <td>{{ run.started_at }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endblock %}
