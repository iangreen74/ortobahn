{% extends "base.html" %}
{% block title %}Ortobahn - Login{% endblock %}
{% block nav_home %}/api/auth/login{% endblock %}
{% block nav_links %}
<li><a href="https://ortobahn.com">Home</a></li>
{% endblock %}
{% block content %}
<h1>Login</h1>

<article>
    <header>Sign in with your email and password</header>
    <form id="login-form">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="you@company.com" required>

        <label for="password">Password</label>
        <input type="password" id="password" name="password" required>

        <div id="login-error" style="display:none; color: var(--pico-del-color); margin-top: 0.5rem;"></div>

        <button type="submit">Login</button>
    </form>
    <p><small><a href="/api/auth/forgot-password">Forgot password?</a></small></p>
</article>

<script>
document.getElementById("login-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const errorEl = document.getElementById("login-error");
    errorEl.style.display = "none";

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    if (!email || !password) return;

    try {
        const resp = await fetch("/api/auth/login", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({email, password}),
        });
        const data = await resp.json();

        if (resp.ok) {
            window.location.href = "{{ next_url | default('/my/dashboard') }}";
        } else if (data.needs_confirmation) {
            window.location.href = "/api/auth/confirm?email=" + encodeURIComponent(email);
        } else {
            errorEl.textContent = data.detail || "Login failed.";
            errorEl.style.display = "block";
        }
    } catch (err) {
        errorEl.textContent = "Network error. Please try again.";
        errorEl.style.display = "block";
    }
});
</script>
{% endblock %}
