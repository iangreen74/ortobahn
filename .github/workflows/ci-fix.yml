name: CI Auto-Fix

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, master]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.head_branch, 'cifix/')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -e ".[dev,web]"

      - name: Attempt lint/format auto-fix
        id: lint_fix
        run: |
          ruff check --fix ortobahn/ tests/ || true
          ruff format ortobahn/ tests/
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate lint fix
        if: steps.lint_fix.outputs.changed == 'true'
        run: |
          ruff check ortobahn/ tests/
          ruff format --check ortobahn/ tests/

      - name: Attempt typecheck fix
        if: steps.lint_fix.outputs.changed == 'false'
        id: mypy_check
        run: |
          set -o pipefail
          if mypy ortobahn/ 2>&1 | tee /tmp/mypy_output.txt; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure git
        if: steps.lint_fix.outputs.changed == 'true'
        run: |
          git config user.name "Ortobahn CI Fix"
          git config user.email "cifix@ortobahn.com"

      - name: Create fix PR
        if: steps.lint_fix.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          BASE_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          BRANCH="cifix/lint-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "cifix: auto-fix lint/format errors

          Automated fix triggered by CI run #${RUN_ID}.
          Applied: ruff check --fix && ruff format

          Co-Authored-By: Ortobahn CI Fix <cifix@ortobahn.com>"
          git push origin "$BRANCH"
          cat > /tmp/pr_body.md << 'EOF'
          ## Automated CI Fix

          This PR applies automatic lint and format fixes via `ruff check --fix && ruff format`.

          **No LLM was used** â€” these are purely mechanical fixes.

          ---
          Generated by Ortobahn CI Fix Agent
          EOF
          gh pr create \
            --title "cifix: auto-fix lint/format errors" \
            --body-file /tmp/pr_body.md \
            --base "$BASE_BRANCH"
